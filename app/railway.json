{
  "$schema": "https://railway.app/railway.schema.json",
  "build": {
    "builder": "NIXPACKS",
    "buildCommand": "npm run install:all && npm run app:build",
    "watchPatterns": [
      "app/**",
      "db/**",
      "package.json",
      "package-lock.json"
    ]
  },
  "deploy": {
    "numReplicas": 1,
    "restartPolicyType": "ON_FAILURE",
    "restartPolicyMaxRetries": 10,
    "startCommand": "node app/server.js",
    "healthcheckPath": "/api/health",
    "healthcheckTimeout": 300
  },
  "environments": {
    "production": {
      "variables": {
        "NODE_ENV": "production",
        "PORT": "$PORT",
        "FRONTEND_URL": "${{FRONTEND_URL}}",
        "DB_HOST": "${{Postgres.PGHOST}}",
        "DB_PORT": "${{Postgres.PGPORT}}",
        "DB_NAME": "${{Postgres.PGDATABASE}}",
        "DB_USER": "${{Postgres.PGUSER}}",
        "DB_PASSWORD": "${{Postgres.PGPASSWORD}}",
        "DATABASE_URL": "${{Postgres.DATABASE_URL}}",
        "DB_SSL": "true",
        "JWT_SECRET": "${{JWT_SECRET}}",
        "JWT_ACCESS_EXPIRY": "15m",
        "JWT_REFRESH_EXPIRY": "7d",
        "OPENAI_API_KEY": "${{OPENAI_API_KEY}}",
        "OPENAI_MODEL": "gpt-4-vision-preview",
        "OPENAI_FALLBACK_MODEL": "gpt-4",
        "OPENAI_MAX_TOKENS": "1000",
        "OPENAI_TEMPERATURE": "0.7",
        "OPENAI_TIMEOUT": "30000",
        "OPENAI_MAX_RETRIES": "3",
        "OPENAI_RETRY_BASE_DELAY": "1000",
        "OPENAI_RETRY_MAX_DELAY": "10000",
        "OPENAI_RATE_LIMIT_RPM": "${{OPENAI_RATE_LIMIT_RPM}}",
        "OPENAI_RATE_LIMIT_RPD": "${{OPENAI_RATE_LIMIT_RPD}}",
        "OPENAI_RATE_LIMIT_ENABLED": "true",
        "OPENAI_HEALTH_CHECK_INTERVAL": "5",
        "OPENAI_USAGE_LOGGING": "true",
        "OPENAI_COST_TRACKING": "true",
        "OPENAI_CIRCUIT_BREAKER_ENABLED": "true",
        "OPENAI_CIRCUIT_BREAKER_THRESHOLD": "5",
        "OPENAI_CIRCUIT_BREAKER_TIMEOUT": "60000",
        "OPENAI_MOCK_ENABLED": "false",
        "USE_MOCK_OPENAI": "false",
        "OPENAI_ORGANIZATION": "${{OPENAI_ORGANIZATION}}",
        "OPENAI_PROJECT": "${{OPENAI_PROJECT}}",
        "API_KEY": "${{API_KEY}}",
        "RATE_LIMIT_WINDOW": "15",
        "RATE_LIMIT_MAX": "100",
        "SECURITY_LEVEL": "strict",
        "CLOUDINARY_CLOUD_NAME": "${{CLOUDINARY_CLOUD_NAME}}",
        "CLOUDINARY_API_KEY": "${{CLOUDINARY_API_KEY}}",
        "CLOUDINARY_API_SECRET": "${{CLOUDINARY_API_SECRET}}",
        "CLOUDINARY_URL": "${{CLOUDINARY_URL}}",
        "MAX_FILE_SIZE_MB": "10",
        "MAX_AVATAR_SIZE_MB": "2",
        "MAX_IMAGE_SIZE_MB": "5",
        "ALLOWED_FILE_TYPES": "jpg,jpeg,png,gif,webp,pdf,doc,docx,txt",
        "USER_STORAGE_QUOTA": "1073741824",
        "ADMIN_STORAGE_QUOTA": "10737418240",
        "LOG_LEVEL": "info",
        "ENABLE_REQUEST_LOGGING": "false",
        "ENABLE_HEALTH_CHECKS": "true",
        "ENABLE_METRICS": "true",
        "SENTRY_DSN": "${{SENTRY_DSN}}"
      }
    },
    "staging": {
      "variables": {
        "NODE_ENV": "staging",
        "PORT": "$PORT",
        "FRONTEND_URL": "${{STAGING_FRONTEND_URL}}",
        "DB_HOST": "${{Postgres.PGHOST}}",
        "DB_PORT": "${{Postgres.PGPORT}}",
        "DB_NAME": "${{Postgres.PGDATABASE}}",
        "DB_USER": "${{Postgres.PGUSER}}",
        "DB_PASSWORD": "${{Postgres.PGPASSWORD}}",
        "DATABASE_URL": "${{Postgres.DATABASE_URL}}",
        "DB_SSL": "true",
        "JWT_SECRET": "${{STAGING_JWT_SECRET}}",
        "JWT_ACCESS_EXPIRY": "15m",
        "JWT_REFRESH_EXPIRY": "7d",
        "OPENAI_API_KEY": "${{STAGING_OPENAI_API_KEY}}",
        "OPENAI_MODEL": "gpt-4-vision-preview",
        "OPENAI_FALLBACK_MODEL": "gpt-4",
        "OPENAI_MAX_TOKENS": "500",
        "OPENAI_TEMPERATURE": "0.7",
        "OPENAI_TIMEOUT": "30000",
        "OPENAI_MAX_RETRIES": "2",
        "OPENAI_RETRY_BASE_DELAY": "1000",
        "OPENAI_RETRY_MAX_DELAY": "5000",
        "OPENAI_RATE_LIMIT_RPM": "30",
        "OPENAI_RATE_LIMIT_RPD": "500",
        "OPENAI_RATE_LIMIT_ENABLED": "true",
        "OPENAI_HEALTH_CHECK_INTERVAL": "10",
        "OPENAI_USAGE_LOGGING": "true",
        "OPENAI_COST_TRACKING": "true",
        "OPENAI_CIRCUIT_BREAKER_ENABLED": "true",
        "OPENAI_CIRCUIT_BREAKER_THRESHOLD": "3",
        "OPENAI_CIRCUIT_BREAKER_TIMEOUT": "30000",
        "OPENAI_MOCK_ENABLED": "false",
        "API_KEY": "${{STAGING_API_KEY}}",
        "RATE_LIMIT_WINDOW": "15",
        "RATE_LIMIT_MAX": "500",
        "SECURITY_LEVEL": "development",
        "CLOUDINARY_CLOUD_NAME": "${{STAGING_CLOUDINARY_CLOUD_NAME}}",
        "CLOUDINARY_API_KEY": "${{STAGING_CLOUDINARY_API_KEY}}",
        "CLOUDINARY_API_SECRET": "${{STAGING_CLOUDINARY_API_SECRET}}",
        "MAX_FILE_SIZE_MB": "5",
        "MAX_AVATAR_SIZE_MB": "1",
        "MAX_IMAGE_SIZE_MB": "3",
        "ALLOWED_FILE_TYPES": "jpg,jpeg,png,gif,webp",
        "USER_STORAGE_QUOTA": "104857600",
        "ADMIN_STORAGE_QUOTA": "1073741824",
        "LOG_LEVEL": "debug",
        "ENABLE_REQUEST_LOGGING": "true",
        "ENABLE_HEALTH_CHECKS": "true",
        "ENABLE_METRICS": "true"
      }
    }
  }
}